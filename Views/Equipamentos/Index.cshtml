@model IEnumerable<VigiLant.Models.Equipamento>
@{
    ViewData["Title"] = "Equipamentos";
}

<div class="page-header">
    <h1 class="page-title">Equipamentos</h1>
    <div class="breadcrumb">
        <a href="@Url.Action("Index", "Home")">Dashboard</a>
        <span class="separator">/</span>
        <span class="active">Equipamentos</span>
    </div>
</div>

<div class="page-actions">
    <div></div>
    <div class="btts">
        <button type="button" class="btn-secondary" id="btnConfig">
            <i class="fas fa-cog"></i>
        </button>

        <button type="button" class="btn-primary" id="btnConectar" data-action-type="create-modal"
            data-url="@Url.Action("Conectar", "Equipamentos")" data-title="Conectar Equipamento" data-form-id="riscoForm">
            <i class="fas fa-plus"></i>
            Conectar a sensor de Equipamento
        </button>
    </div>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome do Equipamento</th>
                <th>Tipo</th>
                <th>Localização</th>
                <th>Status</th>
                <th>Próxima Manutenção</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var equipamento in Model)
            {
                <tr>
                    <td>#@equipamento.Id</td>
                    <td><strong>@equipamento.Nome</strong></td>
                    <td>@equipamento.TipoSensor</td>
                    <td>@equipamento.Localizacao</td>
                    <td>
                        @if (equipamento.Status == "Ativo")
                        {
                            <span class="status-badge success">@equipamento.Status</span>
                        }
                        else if (equipamento.Status == "Manutenção")
                        {
                            <span class="status-badge warning">@equipamento.Status</span>
                        }
                        else
                        {
                            <span class="status-badge danger">@equipamento.Status</span>
                        }
                    </td>
                    <td>@equipamento.DataUltimaManutencao.ToString("dd/MM/yyyy")</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-icon" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-icon" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="ajax-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modalTitle">Título</h5> <button id="closeModalButton" ...>X</button>
        </div>
        <div id="modalBody" class="modal-body"> </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="/js/Partialjs.js" asp-append-version="true"></script>
    <script>
        // Cria a conexão com o Hub SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/medicaoHub") // Endpoint mapeado no Program.cs
            .withAutomaticReconnect()
            .build();

        // ----------------------------------------------------
        // Lógica de Atualização em Tempo Real da Medição (Corrente)
        // ----------------------------------------------------
        connection.on("ReceberMedicao", function (equipamentoId, corrente) {
            // 1. Localiza a linha correta na tabela pelo ID do equipamento
            const row = document.querySelector(`#equipamentosTable tr[data-equipamento-id="${equipamentoId}"]`);
            if (row) {
                // 2. Encontra a célula de status (quinta coluna)
                const statusCell = row.querySelector('.status-cell');
                if (statusCell) {
                    // 3. Atualiza o conteúdo com a intensidade da corrente
                    statusCell.innerHTML = `<span class="status-badge success"><i class="fas fa-bolt"></i> ${corrente.toFixed(2)}A</span>`;
                }
            }
        });
        
        // ----------------------------------------------------
        // Lógica de Novo Equipamento Conectado (Confirmação do Broker)
        // ----------------------------------------------------
        connection.on("NovoEquipamentoConectado", function (equipamento) {
            // Notifica e recarrega a página para exibir o novo status
            alert(`Equipamento '${equipamento.Nome}' conectado com sucesso (Status: Conectado)!`);
            window.location.reload(); 
        });

        // ----------------------------------------------------
        // Inicia a Conexão
        // ----------------------------------------------------
        async function startSignalR() {
            try {
                await connection.start();
                console.log("Conexão SignalR estabelecida.");
            } catch (err) {
                console.error("Erro ao conectar ao SignalR:", err);
                // Tenta reconectar após 5 segundos
                setTimeout(startSignalR, 5000); 
            }
        };

        // Inicia o processo de conexão
        startSignalR();
        
        // Ajuste no botão de conectar (baseado no seu Index.cshtml)
        document.addEventListener('DOMContentLoaded', function () {
            const btnConectar = document.getElementById('btnConectar');
            if (btnConectar) {
                // Atualiza a URL e o título para usar a nova Partial View e Action
                btnConectar.setAttribute('data-url', '@Url.Action("Conectar", "Equipamentos")');
                btnConectar.setAttribute('data-title', 'Conectar Equipamento MQTT');
                btnConectar.setAttribute('data-form-id', 'equipamentoForm'); // O ID do formulário na partial
            }
        });
    </script>
}