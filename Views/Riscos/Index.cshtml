@using VigiLant.Models.Enum

@model IEnumerable<VigiLant.Models.Risco>
@{
    ViewData["Title"] = "Riscos";
}

<div class="page-header">
    <h1 class="page-title">Riscos</h1>
    <div class="breadcrumb">
        <a href="@Url.Action("Index", "Home")">Dashboard</a>
        <span class="separator">/</span>
        <span class="active">Riscos</span>
    </div>
</div>

<div class="page-actions">
    <div></div>
    <div class="btts">
        <button type="button" class="btn-secondary btn-ajax-modal" id="btnIA" data-action-type="create"
            data-url="@Url.Action("AnaliseRiscos", "IA")" data-title="Análise de Riscos e Soluções (IA)"
            data-form-id="iaAnalysisForm">
            <i class="fas fa-microchip"></i>
            IA
        </button>

        <button type="button" class="btn-primary" id="btnAddRisco" data-action-type="create-modal"
            data-url="@Url.Action("Create", "Riscos")" data-title="Adicionar Novo Risco Manualmente"
            data-form-id="riscoForm" <i class="fas fa-plus"></i>
            Adicionar Novo Risco Manualmente
        </button>
    </div>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome do Risco</th>
                <th>Descrição</th>
                <th>Equipamentos</th>
                <th>Nível de Gravidade</th>
                <th>Status</th>
                <th>Data Identificação</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var risco in Model)
            {
                <tr>
                    <td>#@risco.Id</td>
                    <td>@risco.Nome</td>
                    <td>@(risco.Descricao.Length > 50 ? risco.Descricao.Substring(0, 50) + "..." : risco.Descricao)</td>
                    <td>
                        @{
                            var gravidadeClass = risco.NivelGravidade switch
                            {
                                NivelSeveridade.Critico => "danger",
                                NivelSeveridade.Alto => "danger",
                                NivelSeveridade.Medio => "warning",
                                _ => "success"
                            };
                        }
                        <span class="status-badge @gravidadeClass nivel-gravidade">
                            @risco.NivelGravidade
                        </span>
                    </td>
                    <td>@risco.Equipamento</td>
                    <td>
                        <span class="status-badge info">
                            @risco.Status
                        </span>
                    </td>
                    <td>@risco.DataIdentificacao.ToShortDateString()</td>
                    <td>
                        <div class="table-actions">

                            <button type="button" class="btn-icon btn-ajax-modal" title="Editar" data-id="@risco.Id"
                                data-action-type="edit" data-controller-url="@Url.Content("~/Riscos")"
                                data-title="Editar Risco #{ID}" data-form-id="editRiscoForm">
                                <i class="fas fa-edit"></i>
                            </button>

                            <button type="button" class="btn-icon btn-ajax-modal" title="Ver Detalhes" data-id="@risco.Id"
                                data-action-type="details" data-controller-url="@Url.Content("~/Riscos")"
                                data-title="Detalhes do Risco #{ID}">
                                <i class="fas fa-eye"></i>
                            </button>


                            <button type="button" class="btn-icon btn-ajax-modal text-danger" title="Excluir"
                                data-id="@risco.Id" data-action-type="delete" data-controller-url="@Url.Content("~/Riscos")"
                                data-title="Confirmação de Exclusão #{ID}" data-form-id="deleteForm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="ajax-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modalTitle">Título</h5> <button id="closeModalButton" ...>X</button>
        </div>
        <div id="modalBody" class="modal-body"> </div>
    </div>
</div>

@section Scripts {
    <script src="/js/Partialjs.js" asp-append-version="true"></script>

    <script>
        $(document).ready(function () {
            // 2. Faz a requisição AJAX GET
            $.ajax({
                type: 'GET',
                url: urlAction,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function (response) {
                    // 3. Carrega o conteúdo (Partial View)
                    $('#modalBody').html(response);
                },
                error: function (xhr, status, error) {
                    // 4. Trata erros e exibe mensagem
                    console.error("Erro ao carregar a análise de IA:", error);
                    $('#modalBody').html('<div class="alert alert-danger">Erro ao carregar a análise de IA. Verifique o console para detalhes.</div>');
                }
            });
        });
                    });
    </script>
}